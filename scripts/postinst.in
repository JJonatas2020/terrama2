#!/bin/bash

INSTALL_COMMAND="npm"

function valid()
{
  if [ $1 -ne 0 ]; then
    printf "$2\n"
    exit 1
  fi
}

apt-get install curl

curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -

touch /etc/apt/sources.list.d/pgdg.list
sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -

apt-get update
apt-get install -y cmake libquazip-dev unzip screen openssh-server doxygen supervisor locales nodejs libgsasl7 postgresql-11-postgis-2.5 postgis postgresql-server-dev-11
mkdir $HOME/.ssh/id_rsa
ssh-keygen -t rsa -b 4096 -C "terrama2-team@dpi.inpe.br" -N "" -f $HOME/.ssh/id_rsa

sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres'"

curl -o terralib-5.4.5-ubuntu-16.04.tar.gz -L http://www.dpi.inpe.br/jenkins-data/terrama2/3rdparty/terralib-5.4.5-ubuntu-16.04.tar.gz
tar zxf terralib-5.4.5-ubuntu-16.04.tar.gz
./install.sh

chmod 755 -R @TERRAMA2_DESTINATION@

printf "Post-installation script...\n"

# ${INSTALL_COMMAND} install yarn -g
# valid $? "Unable to install Yarn."

(
  printf "Webapp dependencies...\n"
  cd @TERRAMA2_DESTINATION@webapp

  #
  # Install web dependencies
  #
  ${INSTALL_COMMAND} add grunt
  valid $? "Unable to install Grunt."

  ${INSTALL_COMMAND} install
  valid $? "Unable to install NodeJs dependencies."

  ${INSTALL_COMMAND} run grunt
  valid $? "Error executing grunt.\n"

  chmod +x bin/webapp-stop.js
  chmod 755 bin/webapp-stop.js
)

(
  printf "Webcomponents dependencies...\n"
  cd @TERRAMA2_DESTINATION@webcomponents

  ${INSTALL_COMMAND} add grunt
  valid $? "Unable to install Grunt."

  ${INSTALL_COMMAND} install
  valid $? "Unable to install NodeJs dependencies."
  ${INSTALL_COMMAND} run grunt
  valid $? "Error executing grunt."
)

(
  printf "Webmonitor dependencies...\n"
  cd @TERRAMA2_DESTINATION@webmonitor

  #
  # Install web dependencies
  #
  ${INSTALL_COMMAND} add grunt
  valid $? "Unable to install Grunt."

  ${INSTALL_COMMAND} install
  valid $? "Unable to install NodeJs dependencies."

  ${INSTALL_COMMAND} run grunt
  valid $? "Error executing grunt."
)

#
# Create default config files
#
(
  cd @TERRAMA2_DESTINATION@webapp/config
  if ! [ -f "settings.json" ]; then
    cp settings.json.example settings.json
  fi
)
(
  cd @TERRAMA2_DESTINATION@webapp/config
  if ! [ -f "db.json" ]; then
    cp db.json.example db.json
  fi
)
(
  cd @TERRAMA2_DESTINATION@webmonitor/config
  if ! [ -d "instances" ]; then
    cp -r sample_instances instances
  fi
)

# Check if pm2 is already installed
npm list pm2 -g
if [ $? != 0 ]; then
  printf "Configuring pm2...\n"
  # Install pm2
  npm install pm2 -g
  valid $? "Error installing pm2."
  pm2 install pm2-logrotate
  valid $? "Error installing pm2-logrotate."
  # Allows the service to start with the system
  env PATH=$PATH:/usr/local/bin pm2 startup
  valid $? "Error adding pm2 to startup."
fi

# Add webapp to pm2 startup
(
  cd @TERRAMA2_DESTINATION@webapp
  pm2 delete webapp

  pm2 start npm --name webapp -- start
  valid $? "Error executing webapp."
  pm2 save
  valid $? "Error saving pm2 state."
)

# Add webmonitor to pm2 startup
(
  cd @TERRAMA2_DESTINATION@webmonitor
  pm2 delete webmonitor

  pm2 start npm --name webmonitor -- start
  valid $? "Error executing webmonitor."
  pm2 save
  valid $? "Error saving pm2 state."
)

printf "End post-installation script...\n\n"

exit 0
